<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Check food products against biblical dietary laws">
    <meta name="theme-color" content="#2563eb">
    <title>Biblical Diet Checker</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #4169E1 0%, #6495ED 100%);
            min-height: 100vh;
            color: #111827;
            line-height: 1.6;
        }

        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        h1 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 1rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
        }

        .tab-button:hover {
            color: #2563eb;
        }

        .tab-button.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* Barcode Scanner */
        .barcode-section {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        #video {
            width: 100%;
            max-width: 500px;
            border-radius: 0.5rem;
            display: block;
            background: #000;
        }

        #videoContainer {
            max-width: 500px;
            margin: 0 auto;
        }

        .scanner-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .filters {
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
        }

        .filter-section {
            margin-bottom: 1rem;
        }

        .filter-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .filter-title.secondary {
            color: #6b7280;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .filter-item input {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }

        .filter-item label {
            font-size: 0.875rem;
            cursor: pointer;
        }

        .product-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .product-name {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .product-brand {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .status.compliant {
            color: #059669;
        }

        .status.not-compliant {
            color: #dc2626;
        }

        .status.no-data {
            color: #9ca3af;
        }

        .violations {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }

        .violations-title {
            font-weight: 600;
            color: #991b1b;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .violation-item {
            font-size: 0.875rem;
            color: #7f1d1d;
            margin-bottom: 0.25rem;
        }

        .violation-note {
            font-size: 0.75rem;
            color: #dc2626;
            margin-left: 1rem;
            display: block;
        }

        .toggle-btn {
            margin-top: 0.75rem;
            color: #2563eb;
            background: none;
            border: none;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .toggle-btn:hover {
            text-decoration: underline;
        }

        .ingredients-box {
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }

        .ingredients-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .ingredients-text {
            font-size: 0.875rem;
            color: #374151;
            line-height: 1.6;
        }

        /* Red highlighting for unclean ingredients */
        .unclean-ingredient {
            background-color: #fee2e2;
            color: #dc2626;
            font-weight: 600;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #9ca3af;
        }

        /* Scripture Tab */
        .scripture-content {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .scripture-section {
            margin-bottom: 2rem;
        }

        .scripture-section h3 {
            color: #2563eb;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .scripture-section h4 {
            color: #374151;
            font-size: 1rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .scripture-list {
            list-style-type: disc;
            margin-left: 1.5rem;
            color: #4b5563;
        }

        .scripture-list li {
            margin-bottom: 0.5rem;
        }

        .scripture-verse {
            background: #f0f9ff;
            border-left: 4px solid #2563eb;
            padding: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #1e3a8a;
        }

        .verse-ref {
            display: block;
            margin-top: 0.5rem;
            font-weight: 600;
            font-style: normal;
            font-size: 0.875rem;
        }

        @media (max-width: 640px) {
            .tab-nav {
                flex-wrap: wrap;
            }

            .tab-button {
                flex: 1;
                min-width: 100px;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Biblical Diet Checker</h1>
            <p class="subtitle">Verify food products against Levitical dietary laws</p>
            
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-button active" onclick="switchTab('search')">Search</button>
                <button class="tab-button" onclick="switchTab('ingredients')">Ingredients</button>
                <button class="tab-button" onclick="switchTab('scripture')">Scripture</button>
            </div>

            <!-- Search Tab -->
            <div id="search-tab" class="tab-content active">
                <div class="search-box">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="search-input" 
                        placeholder="Search for a food product..."
                    >
                    <button id="searchBtn" class="btn">
                        <span>Search</span>
                    </button>
                </div>

                <!-- Barcode Scanner Section -->
                <div class="barcode-section">
                    <h3 style="margin-bottom: 1rem; font-size: 1.125rem;">üì∑ Barcode Scanner</h3>
                    
                    <!-- Mobile Scanner -->
                    <div id="mobileScannerSection" style="display: none;">
                        <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                            Click "Start Scanner" to use your camera to scan product barcodes
                        </p>
                        <div class="scanner-controls">
                            <button id="startScanBtn" class="btn" onclick="startBarcodeScanner()">
                                Start Scanner
                            </button>
                            <button id="stopScanBtn" class="btn btn-secondary" onclick="stopBarcodeScanner()" style="display: none;">
                                Stop Scanner
                            </button>
                        </div>
                        <div id="videoContainer" style="position: relative; display: none; margin-top: 1rem;">
                            <video id="video"></video>
                            <svg id="scanLine" style="position: absolute; top: 50%; left: 0; right: 0; width: 100%; height: 2px; pointer-events: none;">
                                <line x1="10%" y1="0" x2="90%" y2="0" stroke="#dc2626" stroke-width="3">
                                    <animate attributeName="y1" values="0;0" dur="2s" repeatCount="indefinite"/>
                                    <animate attributeName="y2" values="0;0" dur="2s" repeatCount="indefinite"/>
                                </line>
                            </svg>
                        </div>
                        <canvas id="canvas" style="display: none;"></canvas>
                    </div>

                    <!-- Desktop Barcode Input -->
                    <div id="desktopBarcodeSection" style="display: none;">
                        <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                            üì± Camera scanning is available on mobile devices. On desktop, enter the barcode number manually:
                        </p>
                        <div class="search-box">
                            <input 
                                type="text" 
                                id="barcodeInput" 
                                class="search-input" 
                                placeholder="Enter barcode number (e.g., 737628064502)..."
                                pattern="[0-9]*"
                                inputmode="numeric"
                            >
                            <button class="btn" onclick="searchByManualBarcode()">
                                Look Up
                            </button>
                        </div>
                    </div>
                </div>

                <div class="filters">
                    <div class="filter-section">
                        <div class="filter-title">Biblical Restrictions (Leviticus 11)</div>
                        <div class="filter-grid">
                            <div class="filter-item">
                                <input type="checkbox" id="filter-pork" checked>
                                <label for="filter-pork">Pork/Swine</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="filter-shellfish" checked>
                                <label for="filter-shellfish">Shellfish</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="filter-unclean" checked>
                                <label for="filter-unclean">Unclean Animals</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="filter-blood" checked>
                                <label for="filter-blood">Blood Products</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <div class="filter-title secondary">Additional Filters (Optional)</div>
                        <div class="filter-grid">
                            <div class="filter-item">
                                <input type="checkbox" id="filter-dairy">
                                <label for="filter-dairy">Dairy</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="filter-eggs">
                                <label for="filter-eggs">Eggs</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="filter-peanuts">
                                <label for="filter-peanuts">Peanuts</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="filter-soy">
                                <label for="filter-soy">Soy</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ingredients Tab -->
            <div id="ingredients-tab" class="tab-content">
                <h3 style="margin-bottom: 1rem;">Check Individual Ingredients</h3>
                <div class="search-box">
                    <input 
                        type="text" 
                        id="ingredientInput" 
                        class="search-input" 
                        placeholder="Enter ingredient name (e.g., gelatin, shrimp)..."
                    >
                    <button id="checkIngredientBtn" class="btn" onclick="checkSingleIngredient()">
                        Check
                    </button>
                </div>
                <div id="ingredient-result"></div>
            </div>

            <!-- Scripture Tab -->
            <div id="scripture-tab" class="tab-content">
                <div class="scripture-content">
                    <div class="scripture-section">
                        <h3>üìñ Biblical Dietary Laws Summary</h3>
                        <p style="color: #4b5563; margin-bottom: 1rem;">
                            The biblical dietary laws are primarily found in Leviticus 11 and Deuteronomy 14. 
                            These laws distinguish between clean and unclean animals, establishing what is permissible to eat.
                        </p>

                        <div class="scripture-verse">
                            "And the LORD spoke to Moses and Aaron, saying to them, 'Speak to the people of Israel, saying, 
                            These are the living things that you may eat among all the animals that are on the earth.'"
                            <span class="verse-ref">‚Äî Leviticus 11:1-2</span>
                        </div>
                    </div>

                    <div class="scripture-section">
                        <h3>‚úÖ Clean Animals (Permitted)</h3>
                        
                        <h4>Land Animals</h4>
                        <ul class="scripture-list">
                            <li>Must have a split hoof that is completely divided</li>
                            <li>Must chew the cud (ruminants)</li>
                            <li>Examples: cattle, sheep, goats, deer</li>
                        </ul>

                        <h4>Water Creatures</h4>
                        <ul class="scripture-list">
                            <li>Must have both fins and scales</li>
                            <li>Examples: salmon, tuna, bass, trout</li>
                        </ul>

                        <h4>Birds</h4>
                        <ul class="scripture-list">
                            <li>Most birds are clean except those specifically listed as unclean</li>
                            <li>Examples: chicken, turkey, duck, goose</li>
                        </ul>

                        <h4>Insects</h4>
                        <ul class="scripture-list">
                            <li>Only certain locusts, katydids, crickets, and grasshoppers are permitted</li>
                            <li>Most insects are considered unclean</li>
                        </ul>
                    </div>

                    <div class="scripture-section">
                        <h3>‚ùå Unclean Animals (Forbidden)</h3>
                        
                        <h4>Land Animals</h4>
                        <ul class="scripture-list">
                            <li><strong>Pig/Swine</strong> - has a split hoof but does not chew the cud</li>
                            <li><strong>Camel</strong> - chews the cud but does not have a split hoof</li>
                            <li><strong>Rabbit/Hare</strong> - chews the cud but does not have a split hoof</li>
                            <li><strong>Rock badger</strong> - chews the cud but does not have a split hoof</li>
                            <li>All predators and scavengers</li>
                        </ul>

                        <div class="scripture-verse">
                            "And the pig, because it parts the hoof and is cloven-footed but does not chew the cud, 
                            is unclean to you. You shall not eat any of their flesh, and you shall not touch their carcasses; 
                            they are unclean to you."
                            <span class="verse-ref">‚Äî Leviticus 11:7-8</span>
                        </div>

                        <h4>Water Creatures</h4>
                        <ul class="scripture-list">
                            <li><strong>All shellfish</strong> - shrimp, crab, lobster, clams, oysters, mussels</li>
                            <li><strong>Fish without scales</strong> - catfish, shark, eel, sturgeon</li>
                            <li>All water creatures that do not have both fins and scales</li>
                        </ul>

                        <div class="scripture-verse">
                            "Everything in the waters that does not have fins and scales is detestable to you."
                            <span class="verse-ref">‚Äî Leviticus 11:12</span>
                        </div>

                        <h4>Birds</h4>
                        <ul class="scripture-list">
                            <li>Eagles, vultures, buzzards, kites, ravens</li>
                            <li>Owls, night hawks, seagulls</li>
                            <li>Hawks, cormorants, ostriches</li>
                            <li>Storks, herons, bats</li>
                            <li>Generally: birds of prey and scavengers</li>
                        </ul>

                        <h4>Insects and Crawling Things</h4>
                        <ul class="scripture-list">
                            <li>Most winged insects that walk on all fours</li>
                            <li>All creatures that swarm on the ground</li>
                            <li>Lizards, mice, various reptiles</li>
                        </ul>
                    </div>

                    <div class="scripture-section">
                        <h3>ü©∏ Blood Prohibition</h3>
                        <p style="color: #4b5563; margin-bottom: 1rem;">
                            The consumption of blood is strictly forbidden throughout Scripture.
                        </p>

                        <div class="scripture-verse">
                            "If any one of the house of Israel or of the strangers who sojourn among them eats any blood, 
                            I will set my face against that person who eats blood and will cut him off from among his people. 
                            For the life of the flesh is in the blood..."
                            <span class="verse-ref">‚Äî Leviticus 17:10-11</span>
                        </div>

                        <ul class="scripture-list">
                            <li>Blood must be properly drained from meat</li>
                            <li>Blood products and blood-based foods are forbidden</li>
                            <li>This includes blood sausage, blood pudding, and similar products</li>
                        </ul>
                    </div>

                    <div class="scripture-section">
                        <h3>üîç Hidden Ingredients to Watch For</h3>
                        <ul class="scripture-list">
                            <li><strong>Gelatin</strong> - Often derived from pig skin and bones (unless specified as beef or fish gelatin)</li>
                            <li><strong>Lard</strong> - Pig fat</li>
                            <li><strong>Pepsin</strong> - Enzyme often from pig stomach lining</li>
                            <li><strong>Mono and diglycerides</strong> - May be derived from pork or other unclean animal fats</li>
                            <li><strong>Carmine/Cochineal (E120)</strong> - Red dye made from crushed beetles</li>
                            <li><strong>Shellac</strong> - Insect-derived coating used on some candies and pills</li>
                            <li><strong>Natural flavors</strong> - May contain animal-derived ingredients</li>
                        </ul>
                    </div>

                    <div class="scripture-section">
                        <h3>üí° Practical Application</h3>
                        <ul class="scripture-list">
                            <li>Always read ingredient labels carefully</li>
                            <li>When in doubt about an ingredient, research its source</li>
                            <li>Be aware that "natural flavors" can hide animal-derived ingredients</li>
                            <li>Check for kosher certification, which follows similar (though more detailed) guidelines</li>
                            <li>Contact manufacturers when ingredient sources are unclear</li>
                            <li>Remember that these laws were given for holiness and health</li>
                        </ul>

                        <div class="scripture-verse">
                            "For I am the LORD your God. Consecrate yourselves therefore, and be holy, for I am holy. 
                            You shall not defile yourselves with any swarming thing that crawls on the ground. 
                            For I am the LORD who brought you up out of the land of Egypt to be your God. 
                            You shall therefore be holy, for I am holy."
                            <span class="verse-ref">‚Äî Leviticus 11:44-45</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results">
            <div class="empty-state">Search for products to see results</div>
        </div>
    </div>

    <!-- Include ZXing library for barcode scanning -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>

    <script>
        const biblicalRestrictions = {
            pork: ['pork', 'pig', 'swine', 'bacon', 'ham', 'lard', 'pepsin', 'pancreatin'],
            shellfish: ['shrimp', 'prawn', 'crab', 'lobster', 'crayfish', 'clam', 'oyster', 'mussel', 'scallop', 'squid', 'octopus', 'catfish', 'eel', 'shark'],
            uncleanAnimals: ['rabbit', 'hare', 'camel', 'horse', 'snail', 'frog'],
            insects: ['carmine', 'cochineal', 'shellac', 'e120'],
            blood: ['blood', 'blood meal', 'blood sausage', 'black pudding']
        };

        const allergenRestrictions = {
            dairy: ['milk', 'cream', 'butter', 'cheese', 'whey', 'casein', 'lactose', 'yogurt', 'milkfat', 'buttermilk'],
            eggs: ['egg', 'albumin', 'lysozyme', 'ovalbumin'],
            peanuts: ['peanut', 'groundnut', 'arachis'],
            soy: ['soy', 'soya', 'soybean', 'lecithin', 'tofu', 'edamame']
        };

        const hiddenIngredients = {
            'gelatin': 'Usually pork-derived unless specified as beef or fish gelatin',
            'mono and diglycerides': 'May be derived from pork or other animal fats',
            'animal shortening': 'May contain pork fat',
            'carmine': 'Red dye made from cochineal beetles',
            'cochineal': 'Insect-derived red coloring'
        };

        let openProducts = new Set();
        let codeReader = null;
        let currentStream = null;
        let scanningInterval = null;

        // Detect if user is on mobile device
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (window.innerWidth <= 768);
        }

        // Initialize page - show appropriate barcode section
        window.addEventListener('DOMContentLoaded', () => {
            if (isMobileDevice()) {
                document.getElementById('mobileScannerSection').style.display = 'block';
                document.getElementById('desktopBarcodeSection').style.display = 'none';
            } else {
                document.getElementById('mobileScannerSection').style.display = 'none';
                document.getElementById('desktopBarcodeSection').style.display = 'block';
            }
        });

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        // Manual barcode input for desktop
        function searchByManualBarcode() {
            const barcodeInput = document.getElementById('barcodeInput');
            const barcode = barcodeInput.value.trim();
            
            if (!barcode) {
                alert('Please enter a barcode number');
                return;
            }
            
            if (!/^\d+$/.test(barcode)) {
                alert('Barcode should only contain numbers');
                return;
            }
            
            searchByBarcode(barcode);
        }

        // Barcode scanner functions for mobile
        async function startBarcodeScanner() {
            try {
                const videoElement = document.getElementById('video');
                const videoContainer = document.getElementById('videoContainer');
                
                videoContainer.style.display = 'block';
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'inline-flex';

                // Request camera access with back camera preference
                const constraints = {
                    video: { 
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = currentStream;
                await videoElement.play();

                // Initialize ZXing barcode reader
                codeReader = new ZXing.BrowserMultiFormatReader();
                
                // Start continuous scanning
                const hints = new Map();
                const formats = [
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.EAN_8,
                    ZXing.BarcodeFormat.UPC_A,
                    ZXing.BarcodeFormat.UPC_E,
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.CODE_39
                ];
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
                
                codeReader.decodeFromVideoDevice(
                    undefined, // Use default camera
                    'video',
                    (result, error) => {
                        if (result) {
                            console.log('Barcode detected:', result.text);
                            // Play success feedback
                            navigator.vibrate && navigator.vibrate(200);
                            searchByBarcode(result.text);
                            stopBarcodeScanner();
                        }
                        if (error && !(error instanceof ZXing.NotFoundException)) {
                            console.error('Scan error:', error);
                        }
                    }
                );

            } catch (error) {
                console.error('Camera access error:', error);
                alert('Unable to access camera. Please ensure you have granted camera permissions and are using HTTPS.');
                stopBarcodeScanner();
            }
        }

        function stopBarcodeScanner() {
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }

            const videoElement = document.getElementById('video');
            const videoContainer = document.getElementById('videoContainer');
            
            videoContainer.style.display = 'none';
            videoElement.srcObject = null;
            
            document.getElementById('startScanBtn').style.display = 'inline-flex';
            document.getElementById('stopScanBtn').style.display = 'none';
        }

        async function searchByBarcode(barcode) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Looking up barcode...</div>';

            try {
                const response = await fetch(
                    `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`
                );
                
                const data = await response.json();
                
                if (data.status === 1 && data.product) {
                    currentProducts = [data.product];
                    renderCurrentResults();
                    
                    // Scroll to results
                    resultsDiv.scrollIntoView({ behavior: 'smooth' });
                } else {
                    resultsDiv.innerHTML = '<div class="empty-state">Product not found in database. Try searching by name.</div>';
                    currentProducts = [];
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="empty-state">Error looking up barcode. Please try again.</div>';
                console.error('Barcode lookup error:', error);
                currentProducts = [];
            }
        }

        function getFilters() {
            return {
                pork: document.getElementById('filter-pork').checked,
                shellfish: document.getElementById('filter-shellfish').checked,
                unclean: document.getElementById('filter-unclean').checked,
                blood: document.getElementById('filter-blood').checked,
                dairy: document.getElementById('filter-dairy').checked,
                eggs: document.getElementById('filter-eggs').checked,
                peanuts: document.getElementById('filter-peanuts').checked,
                soy: document.getElementById('filter-soy').checked
            };
        }

        function checkIngredient(ingredient, filters) {
            const lower = ingredient.toLowerCase();
            const violations = [];
            const uncleanTerms = []; // Track which terms are unclean

            if (filters.pork) {
                biblicalRestrictions.pork.forEach(item => {
                    if (lower.includes(item)) {
                        violations.push({ type: 'biblical', category: 'Pork/Swine', ingredient });
                        uncleanTerms.push(item);
                    }
                });
            }

            if (filters.shellfish) {
                biblicalRestrictions.shellfish.forEach(item => {
                    if (lower.includes(item)) {
                        violations.push({ type: 'biblical', category: 'Shellfish/Unclean Seafood', ingredient });
                        uncleanTerms.push(item);
                    }
                });
            }

            if (filters.unclean) {
                biblicalRestrictions.uncleanAnimals.forEach(item => {
                    if (lower.includes(item)) {
                        violations.push({ type: 'biblical', category: 'Unclean Animals', ingredient });
                        uncleanTerms.push(item);
                    }
                });
                biblicalRestrictions.insects.forEach(item => {
                    if (lower.includes(item)) {
                        violations.push({ type: 'biblical', category: 'Insects', ingredient });
                        uncleanTerms.push(item);
                    }
                });
            }

            if (filters.blood) {
                biblicalRestrictions.blood.forEach(item => {
                    if (lower.includes(item)) {
                        violations.push({ type: 'biblical', category: 'Blood Products', ingredient });
                        uncleanTerms.push(item);
                    }
                });
            }

            Object.keys(hiddenIngredients).forEach(hidden => {
                if (lower.includes(hidden)) {
                    violations.push({ type: 'hidden', category: 'Hidden/Questionable', ingredient, note: hiddenIngredients[hidden] });
                    uncleanTerms.push(hidden);
                }
            });

            if (filters.dairy) {
                allergenRestrictions.dairy.forEach(item => {
                    if (lower.includes(item)) {
                        violations.push({ type: 'allergen', category: 'Dairy', ingredient });
                        uncleanTerms.push(item);
                    }
                });
            }

            if (filters.eggs) {
                allergenRestrictions.eggs.forEach(item => {
                    if (lower.includes(item)) {
                        violations.push({ type: 'allergen', category: 'Eggs', ingredient });
                        uncleanTerms.push(item);
                    }
                });
            }

            if (filters.peanuts) {
                allergenRestrictions.peanuts.forEach(item => {
                    if (lower.includes(item)) {
                        violations.push({ type: 'allergen', category: 'Peanuts', ingredient });
                        uncleanTerms.push(item);
                    }
                });
            }

            if (filters.soy) {
                allergenRestrictions.soy.forEach(item => {
                    if (lower.includes(item)) {
                        violations.push({ type: 'allergen', category: 'Soy', ingredient });
                        uncleanTerms.push(item);
                    }
                });
            }

            return { violations, uncleanTerms };
        }

        // Function to highlight unclean ingredients in red
        function highlightUncleanIngredient(ingredient, uncleanTerms) {
            if (uncleanTerms.length === 0) {
                return ingredient;
            }

            let highlighted = ingredient;
            const lower = ingredient.toLowerCase();

            // Sort terms by length (longest first) to avoid partial replacements
            const sortedTerms = [...new Set(uncleanTerms)].sort((a, b) => b.length - a.length);

            sortedTerms.forEach(term => {
                const regex = new RegExp(`(${term})`, 'gi');
                highlighted = highlighted.replace(regex, '<span class="unclean-ingredient">$1</span>');
            });

            return highlighted;
        }

        function analyzeProduct(product, filters) {
            if (!product.ingredients_text) return { compliant: null, violations: [], ingredientsHtml: '' };
            
            const ingredients = product.ingredients_text.split(',').map(i => i.trim());
            const allViolations = [];
            const ingredientsWithHighlighting = [];

            ingredients.forEach(ingredient => {
                const { violations, uncleanTerms } = checkIngredient(ingredient, filters);
                allViolations.push(...violations);
                
                // Highlight the ingredient if it contains unclean terms
                const highlightedIngredient = highlightUncleanIngredient(ingredient, uncleanTerms);
                ingredientsWithHighlighting.push(highlightedIngredient);
            });

            return {
                compliant: allViolations.length === 0,
                violations: allViolations,
                ingredientsHtml: ingredientsWithHighlighting.join(', ')
            };
        }

        function toggleIngredients(code) {
            if (openProducts.has(code)) {
                openProducts.delete(code);
            } else {
                openProducts.add(code);
            }
            renderCurrentResults();
        }

        let currentProducts = [];

        function renderCurrentResults() {
            const resultsDiv = document.getElementById('results');
            const filters = getFilters();
            
            if (currentProducts.length === 0) {
                resultsDiv.innerHTML = '<div class="empty-state">Search for products to see results</div>';
                return;
            }

            const productsWithAnalysis = currentProducts.map(p => ({
                ...p,
                analysis: analyzeProduct(p, filters)
            }));

            resultsDiv.innerHTML = productsWithAnalysis.map(product => {
                const isOpen = openProducts.has(product.code);
                const statusClass = product.analysis.compliant === null ? 'no-data' : 
                                   product.analysis.compliant ? 'compliant' : 'not-compliant';
                const statusText = product.analysis.compliant === null ? 'No Ingredient Data' :
                                  product.analysis.compliant ? '‚úì Compliant' : '‚úó Not Compliant';

                return `
                    <div class="product-card">
                        <div class="product-header">
                            <div>
                                <div class="product-name">${product.product_name || 'Unknown Product'}</div>
                                <div class="product-brand">${product.brands || 'Unknown Brand'}</div>
                            </div>
                            <div class="status ${statusClass}">${statusText}</div>
                        </div>

                        ${product.analysis.violations.length > 0 ? `
                            <div class="violations">
                                <div class="violations-title">‚ö† Issues Found:</div>
                                ${product.analysis.violations.map(v => `
                                    <div class="violation-item">
                                        <strong>${v.category}:</strong> ${v.ingredient}
                                        ${v.note ? `<span class="violation-note">(${v.note})</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${product.ingredients_text ? `
                            <button class="toggle-btn" onclick="toggleIngredients('${product.code}')">
                                ‚Ñπ ${isOpen ? 'Hide' : 'View'} Full Ingredients
                            </button>
                            ${isOpen ? `
                                <div class="ingredients-box">
                                    <div class="ingredients-title">Ingredients:</div>
                                    <div class="ingredients-text">${product.analysis.ingredientsHtml}</div>
                                </div>
                            ` : ''}
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) return;

            const resultsDiv = document.getElementById('results');
            const searchBtn = document.getElementById('searchBtn');
            
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span>Searching...</span>';
            resultsDiv.innerHTML = '<div class="loading">Searching Open Food Facts database...</div>';

            try {
                const response = await fetch(
                    `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(searchTerm)}&search_simple=1&action=process&json=1&page_size=20`
                );
                
                const data = await response.json();
                
                if (data.products && data.products.length > 0) {
                    currentProducts = data.products;
                    renderCurrentResults();
                } else {
                    resultsDiv.innerHTML = '<div class="empty-state">No products found. Try a different search term.</div>';
                    currentProducts = [];
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="empty-state">Error searching. Please try again.</div>';
                console.error('Search error:', error);
                currentProducts = [];
            }

            searchBtn.disabled = false;
            searchBtn.innerHTML = '<span>Search</span>';
        }

        // Single ingredient checker
        function checkSingleIngredient() {
            const ingredientInput = document.getElementById('ingredientInput').value.trim();
            const resultDiv = document.getElementById('ingredient-result');
            
            if (!ingredientInput) {
                resultDiv.innerHTML = '<div class="empty-state">Please enter an ingredient to check</div>';
                return;
            }

            const filters = getFilters();
            const { violations, uncleanTerms } = checkIngredient(ingredientInput, filters);
            const highlightedIngredient = highlightUncleanIngredient(ingredientInput, uncleanTerms);

            if (violations.length === 0) {
                resultDiv.innerHTML = `
                    <div class="product-card">
                        <div class="status compliant" style="font-size: 1.125rem;">
                            ‚úì "${ingredientInput}" appears to be compliant
                        </div>
                        <p style="color: #6b7280; margin-top: 0.75rem; font-size: 0.875rem;">
                            Based on current filter settings, this ingredient does not contain any restricted items.
                        </p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="product-card">
                        <div class="status not-compliant" style="font-size: 1.125rem; margin-bottom: 0.75rem;">
                            ‚úó "${ingredientInput}" is not compliant
                        </div>
                        <div class="ingredients-box">
                            <div class="ingredients-title">Ingredient with violations highlighted:</div>
                            <div class="ingredients-text" style="font-size: 1rem; margin-top: 0.5rem;">
                                ${highlightedIngredient}
                            </div>
                        </div>
                        <div class="violations">
                            <div class="violations-title">‚ö† Issues Found:</div>
                            ${violations.map(v => `
                                <div class="violation-item">
                                    <strong>${v.category}</strong>
                                    ${v.note ? `<span class="violation-note">(${v.note})</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // Event listeners
        document.getElementById('searchBtn').addEventListener('click', searchProducts);
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchProducts();
        });

        document.getElementById('ingredientInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkSingleIngredient();
        });

        // Add listener for barcode input if it exists (desktop only)
        window.addEventListener('DOMContentLoaded', () => {
            const barcodeInput = document.getElementById('barcodeInput');
            if (barcodeInput) {
                barcodeInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchByManualBarcode();
                });
            }
        });

        document.querySelectorAll('.filter-item input').forEach(checkbox => {
            checkbox.addEventListener('change', renderCurrentResults);
        });
    </script>
</body>
</html>
