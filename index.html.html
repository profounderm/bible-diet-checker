<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblical Diet Checker - Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 1rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; border-radius: 1rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 1.5rem; }
        h1 { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #6b7280; margin: 0.5rem 0 1.5rem; }
        .tabs { display: flex; gap: 0.5rem; border-bottom: 2px solid #e5e7eb; margin-bottom: 1.5rem; }
        .tab { padding: 0.75rem 1.5rem; background: none; border: none; font-size: 1rem; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .search-box { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .search-input { flex: 1; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 1rem; }
        .search-input:focus { outline: none; border-color: #667eea; }
        .btn { padding: 1rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; }
        .btn:disabled { background: #9ca3af; }
        .info-badge { display: inline-block; padding: 0.5rem 1rem; background: #eff6ff; border-radius: 0.5rem; font-size: 0.875rem; color: #1e40af; }
        .filters { background: #f9fafb; border-radius: 0.75rem; padding: 1.5rem; margin-top: 1rem; }
        .filter-section { margin-bottom: 1rem; }
        .filter-title { font-weight: 700; margin-bottom: 0.75rem; font-size: 0.875rem; text-transform: uppercase; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; }
        .filter-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; }
        .filter-item input { width: 1.25rem; height: 1.25rem; cursor: pointer; accent-color: #667eea; }
        .content-area { background: white; border-radius: 1rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 2rem; }
        .product-card { border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; }
        .product-name { font-size: 1.25rem; font-weight: 700; }
        .product-brand { color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; }
        .product-source { font-size: 0.75rem; color: #9ca3af; }
        .status-badge { display: inline-flex; padding: 0.5rem 1rem; border-radius: 2rem; font-weight: 700; font-size: 0.875rem; }
        .status-badge.compliant { background: #d1fae5; color: #065f46; }
        .status-badge.not-compliant { background: #fee2e2; color: #991b1b; }
        .status-badge.no-data { background: #fef3c7; color: #92400e; }
        .violations { background: #fef2f2; border-left: 4px solid #dc2626; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; }
        .violation-item { font-size: 0.875rem; color: #7f1d1d; margin-bottom: 0.5rem; }
        .violation-note { font-size: 0.75rem; color: #dc2626; display: block; margin-top: 0.25rem; font-style: italic; }
        .toggle-btn { margin-top: 1rem; padding: 0.5rem 1rem; background: #f3f4f6; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; color: #667eea; }
        .ingredients-box { background: #f9fafb; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; }
        .ingredient-result { background: #f9fafb; border-left: 4px solid #667eea; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; }
        .ingredient-name { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .ingredient-category { display: inline-block; padding: 0.25rem 0.75rem; background: #fee2e2; color: #991b1b; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; margin-bottom: 1rem; }
        .ingredient-description { color: #4b5563; line-height: 1.6; }
        .common-ingredients { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .ingredient-card { border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; cursor: pointer; }
        .ingredient-card:hover { border-color: #667eea; }
        .recently-viewed { margin-bottom: 2rem; }
        .recent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
        .recent-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; cursor: pointer; }
        @media (max-width: 768px) { .search-box { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìñ Biblical Diet Checker</h1>
            <p class="subtitle">Fast, accurate, educational dietary checking</p>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('search')">üîç Search</button>
                <button class="tab" onclick="switchTab('ingredients')">üìö Ingredients</button>
            </div>

            <div id="search-tab" class="tab-content active">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search products...">
                    <button id="searchBtn" class="btn">Search</button>
                </div>
                <span class="info-badge">‚ö° 60+ products offline ‚Ä¢ Restaurant chains supported</span>

                <div class="filters">
                    <div class="filter-section">
                        <div class="filter-title" style="color: #667eea;">Biblical Restrictions</div>
                        <div class="filter-grid">
                            <div class="filter-item"><input type="checkbox" id="filter-pork" checked><label for="filter-pork">Pork</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-shellfish" checked><label for="filter-shellfish">Shellfish</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-unclean" checked><label for="filter-unclean">Unclean Animals</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-blood" checked><label for="filter-blood">Blood</label></div>
                        </div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-title" style="color: #6b7280;">Allergens (Optional)</div>
                        <div class="filter-grid">
                            <div class="filter-item"><input type="checkbox" id="filter-dairy"><label for="filter-dairy">Dairy</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-eggs"><label for="filter-eggs">Eggs</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-peanuts"><label for="filter-peanuts">Peanuts</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-soy"><label for="filter-soy">Soy</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ingredients-tab" class="tab-content">
                <input type="text" id="ingredientInput" class="search-input" style="margin-bottom: 1rem;" placeholder="Search ingredient (e.g., gelatin, carmine)...">
                <div id="ingredientResult"></div>
                <h3 style="margin: 1.5rem 0 0.5rem;">Common Hidden Ingredients</h3>
                <div class="common-ingredients" id="commonIngredients"></div>
            </div>
        </div>

        <div class="content-area">
            <div id="recentlyViewed" class="recently-viewed" style="display:none;">
                <h3 style="margin-bottom: 1rem;">Recently Viewed</h3>
                <div class="recent-grid" id="recentGrid"></div>
            </div>
            <div id="results"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script>
        const offlineDB = [
            {code:'1',name:'Oreo Cookies',brand:'Nabisco',ing:'Unbleached enriched flour, sugar, palm oil, canola oil, cocoa, high fructose corn syrup, leavening, cornstarch, salt, soy lecithin, vanillin, chocolate',src:'offline'},
            {code:'2',name:'Frosted Mini Wheats',brand:'Kelloggs',ing:'Whole grain wheat, sugar, gelatin, contains 2% or less of salt, malt flavor, BHT',src:'offline'},
            {code:'3',name:'Campbells Chicken Noodle Soup',brand:'Campbells',ing:'Chicken stock, enriched egg noodles, chicken meat, carrots, celery, salt, chicken fat, monosodium glutamate',src:'offline'},
            {code:'4',name:'Starburst',brand:'Mars',ing:'Corn syrup, sugar, hydrogenated palm kernel oil, apple juice concentrate, citric acid, tapioca dextrin, gelatin, modified corn starch',src:'offline'},
            {code:'5',name:'Doritos Nacho Cheese',brand:'Frito-Lay',ing:'Corn, vegetable oil, maltodextrin, salt, cheddar cheese, whey, monosodium glutamate, buttermilk',src:'offline'},
            {code:'6',name:'Coca-Cola',brand:'Coca-Cola',ing:'Carbonated water, high fructose corn syrup, caramel color, phosphoric acid, natural flavors, caffeine',src:'offline'},
            {code:'7',name:'Cheerios',brand:'General Mills',ing:'Whole grain oats, modified corn starch, sugar, salt, tripotassium phosphate, vitamin E',src:'offline'},
            {code:'8',name:'Lays Classic Chips',brand:'Frito-Lay',ing:'Potatoes, vegetable oil, salt',src:'offline'},
            {code:'9',name:'Jell-O Strawberry',brand:'Kraft',ing:'Sugar, gelatin, adipic acid, contains less than 2% of artificial flavor, disodium phosphate, sodium citrate, fumaric acid, red 40',src:'offline'},
            {code:'10',name:'Yoplait Yogurt',brand:'General Mills',ing:'Cultured pasteurized grade A low fat milk, sugar, strawberries, modified corn starch, kosher gelatin, citric acid, natural flavor, pectin, colored with carmine',src:'offline'},
            {code:'11',name:'Campbells Clam Chowder',brand:'Campbells',ing:'Water, clams, potatoes, wheat flour, vegetable oil, modified food starch, salt, butter, clam juice concentrate',src:'offline'},
            
            // Breakfast cereals
            {code:'12',name:'Frosted Flakes',brand:'Kelloggs',ing:'Milled corn, sugar, malt flavor, contains 2% or less of salt, BHT for freshness',src:'offline'},
            {code:'13',name:'Honey Nut Cheerios',brand:'General Mills',ing:'Whole grain oats, sugar, oat bran, modified corn starch, honey, brown sugar syrup, salt, tripotassium phosphate, canola oil, natural almond flavor, vitamin E',src:'offline'},
            {code:'14',name:'Lucky Charms',brand:'General Mills',ing:'Whole grain oats, sugar, corn starch, modified corn starch, corn syrup, dextrose, gelatin, trisodium phosphate, red 40, yellow 5 and 6, blue 1, natural and artificial flavor',src:'offline'},
            {code:'15',name:'Rice Krispies',brand:'Kelloggs',ing:'Rice, sugar, salt, malt flavor, BHT for freshness',src:'offline'},
            {code:'16',name:'Cinnamon Toast Crunch',brand:'General Mills',ing:'Whole grain wheat, sugar, rice flour, canola oil, fructose, maltodextrin, dextrose, salt, cinnamon, trisodium phosphate, soy lecithin, caramel color',src:'offline'},
            
            // Snacks - Chips
            {code:'17',name:'Pringles Original',brand:'Pringles',ing:'Dried potatoes, vegetable oil, degerminated yellow corn flour, cornstarch, rice flour, maltodextrin, mono and diglycerides, salt, wheat starch',src:'offline'},
            {code:'18',name:'Ruffles Cheddar and Sour Cream',brand:'Frito-Lay',ing:'Potatoes, vegetable oil, maltodextrin, salt, whey, cheddar cheese, monosodium glutamate, buttermilk, romano cheese, natural flavors',src:'offline'},
            {code:'19',name:'Tostitos Hint of Lime',brand:'Frito-Lay',ing:'Corn, vegetable oil, salt, maltodextrin, citric acid, sugar, natural flavors',src:'offline'},
            {code:'20',name:'Cheetos Crunchy',brand:'Frito-Lay',ing:'Enriched corn meal, vegetable oil, cheese seasoning, whey, cheddar cheese, buttermilk, salt, monosodium glutamate, natural and artificial flavors, yellow 6',src:'offline'},
            
            // Cookies and Crackers
            {code:'21',name:'Chips Ahoy',brand:'Nabisco',ing:'Unbleached enriched flour, sugar, palm oil, semisweet chocolate chips, high fructose corn syrup, leavening, salt, soy lecithin, natural and artificial flavor, caramel color',src:'offline'},
            {code:'22',name:'Nilla Wafers',brand:'Nabisco',ing:'Unbleached enriched flour, sugar, soybean oil, high fructose corn syrup, partially hydrogenated cottonseed oil, whey, eggs, leavening, salt, natural and artificial flavor',src:'offline'},
            {code:'23',name:'Ritz Crackers',brand:'Nabisco',ing:'Unbleached enriched flour, soybean oil, sugar, partially hydrogenated cottonseed oil, salt, leavening, high fructose corn syrup, soy lecithin, malted barley flour, natural flavor',src:'offline'},
            {code:'24',name:'Wheat Thins Original',brand:'Nabisco',ing:'Whole grain wheat flour, soybean oil, cornstarch, sugar, malt syrup, salt, invert sugar, leavening',src:'offline'},
            {code:'25',name:'Goldfish Crackers',brand:'Pepperidge Farm',ing:'Enriched wheat flour, cheddar cheese, vegetable oils, salt, yeast, sugar, autolyzed yeast extract, paprika, spices, celery, onion powder',src:'offline'},
            
            // Candy
            {code:'26',name:'Skittles',brand:'Mars',ing:'Sugar, corn syrup, hydrogenated palm kernel oil, citric acid, tapioca dextrin, modified corn starch, natural and artificial flavors, colors',src:'offline'},
            {code:'27',name:'M&Ms Plain',brand:'Mars',ing:'Milk chocolate, sugar, cocoa butter, skim milk, lactose, milkfat, soy lecithin, salt, artificial and natural flavors, cornstarch, corn syrup, dextrin, coloring',src:'offline'},
            {code:'28',name:'Reeses Peanut Butter Cups',brand:'Hersheys',ing:'Milk chocolate, peanuts, sugar, dextrose, salt, TBHQ',src:'offline'},
            {code:'29',name:'Sour Patch Kids',brand:'Mondelez',ing:'Sugar, invert sugar, corn syrup, modified corn starch, tartaric acid, citric acid, natural and artificial flavor, yellow 6, red 40, yellow 5, blue 1',src:'offline'},
            {code:'30',name:'Twizzlers',brand:'Hersheys',ing:'Corn syrup, wheat flour, sugar, cornstarch, palm oil, salt, artificial flavor, citric acid, red 40',src:'offline'},
            
            // Beverages
            {code:'31',name:'Pepsi',brand:'PepsiCo',ing:'Carbonated water, high fructose corn syrup, caramel color, sugar, phosphoric acid, caffeine, citric acid, natural flavor',src:'offline'},
            {code:'32',name:'Sprite',brand:'Coca-Cola',ing:'Carbonated water, high fructose corn syrup, citric acid, natural flavors, sodium citrate, sodium benzoate',src:'offline'},
            {code:'33',name:'Dr Pepper',brand:'Dr Pepper',ing:'Carbonated water, high fructose corn syrup, caramel color, phosphoric acid, natural and artificial flavors, sodium benzoate, caffeine',src:'offline'},
            {code:'34',name:'Gatorade Fruit Punch',brand:'PepsiCo',ing:'Water, sugar, dextrose, citric acid, salt, sodium citrate, monopotassium phosphate, natural flavor, red 40',src:'offline'},
            {code:'35',name:'Arizona Iced Tea',brand:'Arizona',ing:'Premium brewed black tea, high fructose corn syrup, citric acid, natural flavors',src:'offline'},
            
            // Bread and Bakery
            {code:'36',name:'Wonder Bread White',brand:'Flowers Foods',ing:'Enriched wheat flour, water, high fructose corn syrup, yeast, soybean oil, salt, calcium propionate, monoglycerides, datem, soy lecithin, calcium sulfate',src:'offline'},
            {code:'37',name:'Thomas English Muffins',brand:'Bimbo Bakeries',ing:'Enriched wheat flour, water, yeast, farina, calcium sulfate, salt, sugar, soybean oil, preservatives, monoglycerides, datem, soy lecithin',src:'offline'},
            {code:'38',name:'Nature Valley Granola Bars',brand:'General Mills',ing:'Whole grain oats, sugar, canola oil, rice flour, honey, brown sugar syrup, salt, soy lecithin, baking soda, natural flavor, vitamin E',src:'offline'},
            
            // Condiments
            {code:'39',name:'Heinz Ketchup',brand:'Kraft Heinz',ing:'Tomato concentrate, distilled vinegar, high fructose corn syrup, corn syrup, salt, spice, onion powder, natural flavoring',src:'offline'},
            {code:'40',name:'French\'s Yellow Mustard',brand:'McCormick',ing:'Distilled vinegar, water, mustard seed, salt, turmeric, paprika, spice, natural flavors, garlic powder',src:'offline'},
            {code:'41',name:'Hellmanns Real Mayonnaise',brand:'Unilever',ing:'Soybean oil, water, whole eggs and egg yolks, vinegar, salt, sugar, lemon juice concentrate, calcium disodium EDTA, natural flavors',src:'offline'},
            {code:'42',name:'Hidden Valley Ranch',brand:'Clorox',ing:'Vegetable oil, water, egg yolk, sugar, salt, buttermilk, natural flavors, spices, garlic, onion, vinegar, phosphoric acid, xanthan gum',src:'offline'},
            
            // Frozen Foods
            {code:'43',name:'Hot Pockets Ham and Cheese',brand:'Nestle',ing:'Enriched flour, water, cooked ham, cheddar cheese, soybean oil, salt, yeast, sugar, whey, romano cheese, natural flavors',src:'offline'},
            {code:'44',name:'Totinos Pizza Rolls Pepperoni',brand:'General Mills',ing:'Enriched flour, water, pepperoni, tomato paste, mozzarella cheese, soybean oil, salt, yeast, sugar, spices, modified cornstarch',src:'offline'},
            {code:'45',name:'Birds Eye Frozen Peas',brand:'Conagra',ing:'Peas',src:'offline'},
            {code:'46',name:'Ore-Ida French Fries',brand:'Heinz',ing:'Potatoes, vegetable oil, salt, dextrose, sodium acid pyrophosphate',src:'offline'},
            
            // Dairy
            {code:'47',name:'Kraft Singles American Cheese',brand:'Kraft Heinz',ing:'Milk, whey, milkfat, milk protein concentrate, salt, calcium phosphate, sodium citrate, whey protein concentrate, sodium phosphate, sorbic acid, apocarotenal, annatto, enzymes, vitamin D3',src:'offline'},
            {code:'48',name:'Philadelphia Cream Cheese',brand:'Kraft Heinz',ing:'Pasteurized milk and cream, salt, carob bean gum, cheese culture',src:'offline'},
            {code:'49',name:'Daisy Sour Cream',brand:'Daisy',ing:'Cultured cream, enzymes',src:'offline'},
            
            // Pasta and Rice
            {code:'50',name:'Barilla Spaghetti',brand:'Barilla',ing:'Semolina, durum wheat flour, niacin, iron, thiamine mononitrate, riboflavin, folic acid',src:'offline'},
            {code:'51',name:'Kraft Mac and Cheese',brand:'Kraft Heinz',ing:'Enriched macaroni, cheese sauce mix, whey, milkfat, milk protein concentrate, salt, sodium tripolyphosphate, citric acid, lactic acid, yellow 5, yellow 6',src:'offline'},
            {code:'52',name:'Uncle Bens White Rice',brand:'Mars',ing:'Enriched long grain parboiled rice, iron, niacin, thiamine mononitrate, folic acid',src:'offline'},
            
            // Canned Goods
            {code:'53',name:'Progresso Chicken Noodle Soup',brand:'General Mills',ing:'Chicken broth, cooked white chicken, egg noodles, carrots, celery, salt, chicken fat, sugar, monosodium glutamate, yeast extract',src:'offline'},
            {code:'54',name:'Campbells Tomato Soup',brand:'Campbells',ing:'Tomato puree, water, wheat flour, high fructose corn syrup, salt, potassium chloride, citric acid, flavoring, ascorbic acid',src:'offline'},
            {code:'55',name:'Del Monte Green Beans',brand:'Del Monte',ing:'Green beans, water, salt',src:'offline'},
            {code:'56',name:'Bush\'s Baked Beans',brand:'Bush Brothers',ing:'Prepared white beans, water, brown sugar, sugar, bacon, salt, mustard, onion powder, spices, garlic powder, natural flavor',src:'offline'},
            
            // Breakfast items
            {code:'57',name:'Eggo Waffles',brand:'Kelloggs',ing:'Enriched flour, water, vegetable oil, eggs, sugar, leavening, salt, whey, soy lecithin',src:'offline'},
            {code:'58',name:'Pop-Tarts Strawberry',brand:'Kelloggs',ing:'Enriched flour, corn syrup, high fructose corn syrup, dextrose, soybean and palm oil, sugar, cracker meal, wheat starch, strawberries, salt, gelatin, leavening, citric acid, modified cornstarch, yellow corn flour, red 40, natural and artificial flavor',src:'offline'},
            {code:'59',name:'Aunt Jemima Pancake Mix',brand:'PepsiCo',ing:'Enriched bleached flour, sugar, leavening, dextrose, salt, calcium carbonate, soybean oil, artificial flavor',src:'offline'},
            {code:'60',name:'Quaker Instant Oatmeal',brand:'PepsiCo',ing:'Whole grain rolled oats, sugar, natural and artificial flavor, salt, calcium carbonate, guar gum, caramel color, niacinamide, vitamin A palmitate, reduced iron, pyridoxine hydrochloride, riboflavin, thiamin mononitrate, folic acid',src:'offline'}
        ];

        const ingDB = {
            gelatin:{name:'Gelatin',cat:'Not Compliant',desc:'Protein from animal bones/skin. Usually pork-derived unless labeled otherwise. Used in gummy candies, marshmallows, yogurt.',concern:'Usually pork. Not biblical.'},
            carmine:{name:'Carmine',cat:'Not Compliant',desc:'Red dye from crushed cochineal insects. Used in yogurt, candy, beverages.',concern:'Insect-derived. Not biblical.'},
            shellac:{name:'Shellac',cat:'Not Compliant',desc:'Resin from lac beetle. Used as glazing on candies and produce.',concern:'Insect secretion. Not biblical.'},
            'mono and diglycerides':{name:'Mono/Diglycerides',cat:'Questionable',desc:'Emulsifiers from animal fats or vegetable oils. Often unclear which.',concern:'May be pork-derived.'}
        };

        const biblical = {
            pork:['pork','pig','swine','bacon','ham','lard','pepsin','pepperoni','salami','prosciutto','sausage','chorizo','pancetta',
                  'jambon','porc','schwein','schinken','cerdo','jamon','maiale','prosciutto','suino'], // Added multilingual pork terms
            shellfish:['shrimp','crab','lobster','clam','oyster','mussel','catfish','eel','crevette','crabe','homard','mollusque',
                      'gambas','cangrejo','langosta','mejillon','granchio','aragosta','cozze'], // Added multilingual shellfish
            unclean:['rabbit','hare','camel'],
            insects:['carmine','cochineal','shellac','e120'],
            blood:['blood','sang']
        };

        const allergens = {
            dairy:['milk','cream','butter','cheese','whey','lactose','yogurt','milkfat'],
            eggs:['egg','albumin'],
            peanuts:['peanut','groundnut'],
            soy:['soy','soya','lecithin','tofu']
        };

        const hidden = {
            'gelatin':'Usually pork-derived',
            'mono and diglycerides':'May be pork/animal fat',
            'carmine':'Insect-derived',
            'cochineal':'Insect-derived',
            'shellac':'Insect secretion'
        };

        let openProds = new Set();
        let recent = JSON.parse(localStorage.getItem('recent')||'[]');
        let currProds = [];

        function getFilters() {
            return {
                pork:document.getElementById('filter-pork').checked,
                shellfish:document.getElementById('filter-shellfish').checked,
                unclean:document.getElementById('filter-unclean').checked,
                blood:document.getElementById('filter-blood').checked,
                dairy:document.getElementById('filter-dairy').checked,
                eggs:document.getElementById('filter-eggs').checked,
                peanuts:document.getElementById('filter-peanuts').checked,
                soy:document.getElementById('filter-soy').checked
            };
        }

        function checkIng(ing,f) {
            const l = ing.toLowerCase();
            const v = [];
            if(f.pork) biblical.pork.forEach(i=>{if(l.includes(i))v.push({cat:'Pork/Swine',ing})});
            if(f.shellfish) biblical.shellfish.forEach(i=>{if(l.includes(i))v.push({cat:'Shellfish',ing})});
            if(f.unclean) biblical.unclean.forEach(i=>{if(l.includes(i))v.push({cat:'Unclean Animals',ing})});
            if(f.unclean) biblical.insects.forEach(i=>{if(l.includes(i))v.push({cat:'Insects',ing})});
            if(f.blood) biblical.blood.forEach(i=>{if(l.includes(i))v.push({cat:'Blood',ing})});
            Object.keys(hidden).forEach(h=>{if(l.includes(h))v.push({cat:'Hidden',ing,note:hidden[h]})});
            if(f.dairy) allergens.dairy.forEach(i=>{if(l.includes(i))v.push({cat:'Dairy',ing})});
            if(f.eggs) allergens.eggs.forEach(i=>{if(l.includes(i))v.push({cat:'Eggs',ing})});
            if(f.peanuts) allergens.peanuts.forEach(i=>{if(l.includes(i))v.push({cat:'Peanuts',ing})});
            if(f.soy) allergens.soy.forEach(i=>{if(l.includes(i))v.push({cat:'Soy',ing})});
            return v;
        }

        function analyze(p,f) {
            // Check for missing ingredient data
            if(!p.ing && !p.ingredients_text) return {ok:null,v:[]};
            if(p.ing === 'NO_INGREDIENT_DATA' || p.ingredients_text === 'NO_INGREDIENT_DATA') {
                return {ok:null,v:[{cat:'Missing Data',ing:'Ingredient information not available',note:'Unable to verify biblical compliance without ingredient list'}]};
            }
            
            const ings = (p.ing||p.ingredients_text).split(',').map(i=>i.trim());
            const all = [];
            ings.forEach(i=>{all.push(...checkIng(i,f))});
            return {ok:all.length===0,v:all};
        }

        function addRecent(p) {
            recent = recent.filter(r=>r.code!==p.code);
            recent.unshift({code:p.code,name:p.name||p.product_name,brand:p.brand||p.brands});
            recent = recent.slice(0,10);
            localStorage.setItem('recent',JSON.stringify(recent));
            renderRecent();
        }

        function renderRecent() {
            const el = document.getElementById('recentlyViewed');
            const grid = document.getElementById('recentGrid');
            if(recent.length===0) {el.style.display='none'; return;}
            el.style.display='block';
            grid.innerHTML = recent.map(r=>`
                <div class="recent-card" onclick="searchSpecific('${r.name}')">
                    <div style="font-weight:600;font-size:0.875rem;">${r.name}</div>
                    <div style="font-size:0.75rem;color:#6b7280;">${r.brand}</div>
                </div>
            `).join('');
        }

        function render() {
            const res = document.getElementById('results');
            const f = getFilters();
            if(currProds.length===0){res.innerHTML='<div style="text-align:center;padding:3rem;color:#6b7280;">Search to see results</div>';return;}
            const analyzed = currProds.map(p=>({...p,a:analyze(p,f)}));
            res.innerHTML = analyzed.map(p=>{
                const open = openProds.has(p.code);
                const hasMissingData = p.a.v.some(v => v.cat === 'Missing Data');
                const badge = hasMissingData ? 'not-compliant' : (p.a.ok===null?'no-data':p.a.ok?'compliant':'not-compliant');
                const text = hasMissingData ? '‚ö† No Data' : (p.a.ok===null?'No Data':p.a.ok?'‚úì Compliant':'‚úó Not Compliant');
                const hasRealIngredients = p.ing && p.ing !== 'NO_INGREDIENT_DATA' || p.ingredients_text && p.ingredients_text !== 'NO_INGREDIENT_DATA';
                return `
                    <div class="product-card">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem;">
                            <div>
                                <div class="product-name">${p.name||p.product_name||'Unknown'}</div>
                                <div class="product-brand">${p.brand||p.brands||'Unknown'}</div>
                                ${p.src?`<div class="product-source">‚ö° ${p.src}</div>`:''}
                            </div>
                            <span class="status-badge ${badge}">${text}</span>
                        </div>
                        ${p.a.v.length>0?`
                            <div class="violations">
                                <div style="font-weight:700;color:#991b1b;margin-bottom:0.75rem;">‚ö† Issues:</div>
                                ${p.a.v.map(v=>`
                                    <div class="violation-item">
                                        <strong>${v.cat}:</strong> ${v.ing}
                                        ${v.note?`<span class="violation-note">(${v.note})</span>`:''}
                                    </div>
                                `).join('')}
                            </div>
                        `:''}
                        ${hasRealIngredients?`
                            <button class="toggle-btn" onclick="toggle('${p.code}')">
                                ${open?'Hide':'View'} Ingredients
                            </button>
                            ${open?`<div class="ingredients-box"><div style="font-weight:700;margin-bottom:0.5rem;font-size:0.875rem;">Ingredients:</div><div style="color:#4b5563;font-size:0.875rem;">${p.ing||p.ingredients_text}</div></div>`:''}
                        `:''}
                    </div>
                `;
            }).join('');
        }

        function toggle(code) {
            openProds.has(code)?openProds.delete(code):openProds.add(code);
            render();
        }

        // FatSecret API Configuration
        const FATSECRET_CONFIG = {
            clientId: 'e70882a787674cb190603c87953e4e35',
            clientSecret: '4fc6292bae3b492db3b4a042b3530b87',
            enabled: true // Restaurant search enabled!
        };

        let fatSecretToken = null;
        let tokenExpiry = 0;

        async function getFatSecretToken() {
            if(!FATSECRET_CONFIG.enabled) return null;
            if(fatSecretToken && Date.now() < tokenExpiry) return fatSecretToken;
            
            try {
                const auth = btoa(`${FATSECRET_CONFIG.clientId}:${FATSECRET_CONFIG.clientSecret}`);
                const r = await fetch('https://oauth.fatsecret.com/connect/token', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${auth}`,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: 'grant_type=client_credentials&scope=basic'
                });
                const data = await r.json();
                fatSecretToken = data.access_token;
                tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000;
                return fatSecretToken;
            } catch(e) {
                console.error('FatSecret auth failed:', e);
                return null;
            }
        }

        async function searchFatSecret(term) {
            if(!FATSECRET_CONFIG.enabled) return null;
            
            const token = await getFatSecretToken();
            if(!token) return null;

            try {
                const r = await fetch(
                    `https://platform.fatsecret.com/rest/server.api?method=foods.search&search_expression=${encodeURIComponent(term)}&format=json&max_results=20&region=US&language=en`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                const data = await r.json();
                
                if(data.foods && data.foods.food) {
                    const foods = Array.isArray(data.foods.food) ? data.foods.food : [data.foods.food];
                    
                    const detailed = await Promise.all(
                        foods.slice(0, 10).map(async food => {
                            try {
                                const detailR = await fetch(
                                    `https://platform.fatsecret.com/rest/server.api?method=food.get.v2&food_id=${food.food_id}&format=json&region=US&language=en`,
                                    {
                                        headers: {
                                            'Authorization': `Bearer ${token}`,
                                            'Content-Type': 'application/json'
                                        }
                                    }
                                );
                                const detail = await detailR.json();
                                return detail.food || null;
                            } catch(e) {
                                return null;
                            }
                        })
                    );

                    // Filter and map results
                    return detailed.filter(f => {
                        if(!f || !f.food_name) return false;
                        
                        // Check if ingredients exist and are in English
                        if(f.ingredients && f.ingredients.ingredient) {
                            const text = f.ingredients.ingredient.toLowerCase();
                            // Reject if it contains obvious French words
                            const frenchIndicators = ['au choix', 'pr√©sents', 'allerg√®nes', 'l√©gumes', 'sauces'];
                            if(frenchIndicators.some(word => text.includes(word))) {
                                return false; // Skip non-English results
                            }
                        }
                        return true;
                    }).map(f => {
                        const hasIngredients = f.ingredients && f.ingredients.ingredient;
                        return {
                            code: f.food_id,
                            name: f.food_name,
                            brand: f.brand_name || 'Restaurant/Chain',
                            ing: hasIngredients ? f.ingredients.ingredient : 'NO_INGREDIENT_DATA',
                            ingredients_text: hasIngredients ? f.ingredients.ingredient : 'NO_INGREDIENT_DATA',
                            src: 'restaurant',
                            missingData: !hasIngredients
                        };
                    });
                }
                return null;
            } catch(e) {
                console.error('FatSecret search failed:', e);
                return null;
            }
        }

        async function search() {
            const term = document.getElementById('searchInput').value.trim().toLowerCase();
            if(!term)return;
            const btn = document.getElementById('searchBtn');
            btn.disabled=true;
            btn.textContent='Searching...';

            const offline = offlineDB.filter(p=>
                p.name.toLowerCase().includes(term)||
                p.brand.toLowerCase().includes(term)
            );

            if(offline.length>0) {
                currProds=offline;
                offline.forEach(p=>addRecent(p));
                render();
                btn.disabled=false;
                btn.textContent='Search';
                return;
            }

            try {
                const r = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(term)}&search_simple=1&action=process&json=1&page_size=20`);
                const d = await r.json();
                if(d.products&&d.products.length>0) {
                    currProds=d.products.map(p=>({...p,src:'api'}));
                    d.products.forEach(p=>addRecent(p));
                    render();
                    btn.disabled=false;
                    btn.textContent='Search';
                    return;
                }
            } catch(e) {
                console.error('Open Food Facts failed:', e);
            }

            if(FATSECRET_CONFIG.enabled) {
                try {
                    const restaurantResults = await searchFatSecret(term);
                    if(restaurantResults && restaurantResults.length > 0) {
                        currProds = restaurantResults;
                        restaurantResults.forEach(p=>addRecent(p));
                        render();
                        btn.disabled=false;
                        btn.textContent='Search';
                        return;
                    }
                } catch(e) {
                    console.error('FatSecret failed:', e);
                }
            }

            document.getElementById('results').innerHTML='<div style="text-align:center;padding:3rem;color:#6b7280;">No products found</div>';
            btn.disabled=false;
            btn.textContent='Search';
        }

        function searchSpecific(name) {
            document.getElementById('searchInput').value=name;
            switchTab('search');
            search();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        function searchIng() {
            const term = document.getElementById('ingredientInput').value.trim().toLowerCase();
            const res = document.getElementById('ingredientResult');
            if(!term){res.innerHTML='';return;}
            const match = ingDB[term];
            if(match) {
                res.innerHTML=`
                    <div class="ingredient-result">
                        <div class="ingredient-name">${match.name}</div>
                        <span class="ingredient-category">${match.cat}</span>
                        <div class="ingredient-description">${match.desc}</div>
                        <div style="color:#dc2626;font-weight:600;margin-top:0.5rem;">‚ö† ${match.concern}</div>
                    </div>
                `;
            } else {
                res.innerHTML='<div style="padding:1rem;color:#6b7280;">Ingredient not in database. Try: gelatin, carmine, shellac</div>';
            }
        }

        function renderCommonIngs() {
            document.getElementById('commonIngredients').innerHTML = Object.keys(ingDB).map(k=>`
                <div class="ingredient-card" onclick="document.getElementById('ingredientInput').value='${k}';searchIng();">
                    <div style="font-weight:700;">${ingDB[k].name}</div>
                    <div style="font-size:0.75rem;color:#6b7280;">${ingDB[k].cat}</div>
                </div>
            `).join('');
        }

        document.getElementById('searchBtn').addEventListener('click',search);
        document.getElementById('searchInput').addEventListener('keypress',e=>{if(e.key==='Enter')search()});
        document.getElementById('ingredientInput').addEventListener('input',searchIng);
        document.querySelectorAll('.filter-item input').forEach(i=>i.addEventListener('change',()=>{
            const id = i.id.replace('filter-','');
            localStorage.setItem(id,i.checked);
            render();
        }));

        Object.keys(biblical).concat(Object.keys(allergens)).forEach(k=>{
            const el = document.getElementById(`filter-${k}`);
            if(el) {
                const saved = localStorage.getItem(k);
                if(saved!==null) el.checked = saved==='true';
            }
        });

        renderRecent();
        renderCommonIngs();
    </script>
</body>
</html>
