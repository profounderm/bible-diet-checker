<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblical Diet Checker - Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 1rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; border-radius: 1rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 1.5rem; }
        h1 { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #6b7280; margin: 0.5rem 0 1.5rem; }
        .tabs { display: flex; gap: 0.5rem; border-bottom: 2px solid #e5e7eb; margin-bottom: 1.5rem; }
        .tab { padding: 0.75rem 1.5rem; background: none; border: none; font-size: 1rem; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .search-box { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .search-input { flex: 1; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 1rem; }
        .search-input:focus { outline: none; border-color: #667eea; }
        .btn { padding: 1rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; }
        .btn:disabled { background: #9ca3af; }
        .info-badge { display: inline-block; padding: 0.5rem 1rem; background: #eff6ff; border-radius: 0.5rem; font-size: 0.875rem; color: #1e40af; }
        .filters { background: #f9fafb; border-radius: 0.75rem; padding: 1.5rem; margin-top: 1rem; }
        .filter-section { margin-bottom: 1rem; }
        .filter-title { font-weight: 700; margin-bottom: 0.75rem; font-size: 0.875rem; text-transform: uppercase; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; }
        .filter-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; }
        .filter-item input { width: 1.25rem; height: 1.25rem; cursor: pointer; accent-color: #667eea; }
        .content-area { background: white; border-radius: 1rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 2rem; }
        .product-card { border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; }
        .product-name { font-size: 1.25rem; font-weight: 700; }
        .product-brand { color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; }
        .product-source { font-size: 0.75rem; color: #9ca3af; }
        .status-badge { display: inline-flex; padding: 0.5rem 1rem; border-radius: 2rem; font-weight: 700; font-size: 0.875rem; }
        .status-badge.compliant { background: #d1fae5; color: #065f46; }
        .status-badge.not-compliant { background: #fee2e2; color: #991b1b; }
        .violations { background: #fef2f2; border-left: 4px solid #dc2626; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; }
        .violation-item { font-size: 0.875rem; color: #7f1d1d; margin-bottom: 0.5rem; }
        .violation-note { font-size: 0.75rem; color: #dc2626; display: block; margin-top: 0.25rem; font-style: italic; }
        .toggle-btn { margin-top: 1rem; padding: 0.5rem 1rem; background: #f3f4f6; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; color: #667eea; }
        .ingredients-box { background: #f9fafb; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; }
        .ingredient-result { background: #f9fafb; border-left: 4px solid #667eea; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; }
        .ingredient-name { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .ingredient-category { display: inline-block; padding: 0.25rem 0.75rem; background: #fee2e2; color: #991b1b; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; margin-bottom: 1rem; }
        .ingredient-description { color: #4b5563; line-height: 1.6; }
        .common-ingredients { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .ingredient-card { border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; cursor: pointer; }
        .ingredient-card:hover { border-color: #667eea; }
        .recently-viewed { margin-bottom: 2rem; }
        .recent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
        .recent-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; cursor: pointer; }
        @media (max-width: 768px) { .search-box { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìñ Biblical Diet Checker</h1>
            <p class="subtitle">Fast, accurate, educational dietary checking</p>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('search')">üîç Search</button>
                <button class="tab" onclick="switchTab('ingredients')">üìö Ingredients</button>
            </div>

            <div id="search-tab" class="tab-content active">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search products...">
                    <button id="searchBtn" class="btn">Search</button>
                </div>
                <span class="info-badge">‚ö° 25+ products offline for instant results</span>

                <div class="filters">
                    <div class="filter-section">
                        <div class="filter-title" style="color: #667eea;">Biblical Restrictions</div>
                        <div class="filter-grid">
                            <div class="filter-item"><input type="checkbox" id="filter-pork" checked><label for="filter-pork">Pork</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-shellfish" checked><label for="filter-shellfish">Shellfish</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-unclean" checked><label for="filter-unclean">Unclean Animals</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-blood" checked><label for="filter-blood">Blood</label></div>
                        </div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-title" style="color: #6b7280;">Allergens (Optional)</div>
                        <div class="filter-grid">
                            <div class="filter-item"><input type="checkbox" id="filter-dairy"><label for="filter-dairy">Dairy</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-eggs"><label for="filter-eggs">Eggs</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-peanuts"><label for="filter-peanuts">Peanuts</label></div>
                            <div class="filter-item"><input type="checkbox" id="filter-soy"><label for="filter-soy">Soy</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ingredients-tab" class="tab-content">
                <input type="text" id="ingredientInput" class="search-input" style="margin-bottom: 1rem;" placeholder="Search ingredient (e.g., gelatin, carmine)...">
                <div id="ingredientResult"></div>
                <h3 style="margin: 1.5rem 0 0.5rem;">Common Hidden Ingredients</h3>
                <div class="common-ingredients" id="commonIngredients"></div>
            </div>
        </div>

        <div class="content-area">
            <div id="recentlyViewed" class="recently-viewed" style="display:none;">
                <h3 style="margin-bottom: 1rem;">Recently Viewed</h3>
                <div class="recent-grid" id="recentGrid"></div>
            </div>
            <div id="results"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script>
        const offlineDB = [
            {code:'1',name:'Oreo Cookies',brand:'Nabisco',ing:'Unbleached enriched flour, sugar, palm oil, canola oil, cocoa, high fructose corn syrup, leavening, cornstarch, salt, soy lecithin, vanillin, chocolate',src:'offline'},
            {code:'2',name:'Frosted Mini Wheats',brand:'Kelloggs',ing:'Whole grain wheat, sugar, gelatin, contains 2% or less of salt, malt flavor, BHT',src:'offline'},
            {code:'3',name:'Campbells Chicken Noodle Soup',brand:'Campbells',ing:'Chicken stock, enriched egg noodles, chicken meat, carrots, celery, salt, chicken fat, monosodium glutamate',src:'offline'},
            {code:'4',name:'Starburst',brand:'Mars',ing:'Corn syrup, sugar, hydrogenated palm kernel oil, apple juice concentrate, citric acid, tapioca dextrin, gelatin, modified corn starch',src:'offline'},
            {code:'5',name:'Doritos Nacho Cheese',brand:'Frito-Lay',ing:'Corn, vegetable oil, maltodextrin, salt, cheddar cheese, whey, monosodium glutamate, buttermilk',src:'offline'},
            {code:'6',name:'Coca-Cola',brand:'Coca-Cola',ing:'Carbonated water, high fructose corn syrup, caramel color, phosphoric acid, natural flavors, caffeine',src:'offline'},
            {code:'7',name:'Cheerios',brand:'General Mills',ing:'Whole grain oats, modified corn starch, sugar, salt, tripotassium phosphate, vitamin E',src:'offline'},
            {code:'8',name:'Lays Classic Chips',brand:'Frito-Lay',ing:'Potatoes, vegetable oil, salt',src:'offline'},
            {code:'9',name:'Jell-O Strawberry',brand:'Kraft',ing:'Sugar, gelatin, adipic acid, contains less than 2% of artificial flavor, disodium phosphate, sodium citrate, fumaric acid, red 40',src:'offline'},
            {code:'10',name:'Yoplait Yogurt',brand:'General Mills',ing:'Cultured pasteurized grade A low fat milk, sugar, strawberries, modified corn starch, kosher gelatin, citric acid, natural flavor, pectin, colored with carmine',src:'offline'},
            {code:'11',name:'Campbells Clam Chowder',brand:'Campbells',ing:'Water, clams, potatoes, wheat flour, vegetable oil, modified food starch, salt, butter, clam juice concentrate',src:'offline'}
        ];

        const ingDB = {
            gelatin:{name:'Gelatin',cat:'Not Compliant',desc:'Protein from animal bones/skin. Usually pork-derived unless labeled otherwise. Used in gummy candies, marshmallows, yogurt.',concern:'Usually pork. Not biblical.'},
            carmine:{name:'Carmine',cat:'Not Compliant',desc:'Red dye from crushed cochineal insects. Used in yogurt, candy, beverages.',concern:'Insect-derived. Not biblical.'},
            shellac:{name:'Shellac',cat:'Not Compliant',desc:'Resin from lac beetle. Used as glazing on candies and produce.',concern:'Insect secretion. Not biblical.'},
            'mono and diglycerides':{name:'Mono/Diglycerides',cat:'Questionable',desc:'Emulsifiers from animal fats or vegetable oils. Often unclear which.',concern:'May be pork-derived.'}
        };

        const biblical = {
            pork:['pork','pig','swine','bacon','ham','lard','pepsin'],
            shellfish:['shrimp','crab','lobster','clam','oyster','mussel','catfish','eel'],
            unclean:['rabbit','hare','camel'],
            insects:['carmine','cochineal','shellac','e120'],
            blood:['blood']
        };

        const allergens = {
            dairy:['milk','cream','butter','cheese','whey','lactose','yogurt','milkfat'],
            eggs:['egg','albumin'],
            peanuts:['peanut','groundnut'],
            soy:['soy','soya','lecithin','tofu']
        };

        const hidden = {
            'gelatin':'Usually pork-derived',
            'mono and diglycerides':'May be pork/animal fat',
            'carmine':'Insect-derived',
            'cochineal':'Insect-derived',
            'shellac':'Insect secretion'
        };

        let openProds = new Set();
        let recent = JSON.parse(localStorage.getItem('recent')||'[]');
        let currProds = [];

        function getFilters() {
            return {
                pork:document.getElementById('filter-pork').checked,
                shellfish:document.getElementById('filter-shellfish').checked,
                unclean:document.getElementById('filter-unclean').checked,
                blood:document.getElementById('filter-blood').checked,
                dairy:document.getElementById('filter-dairy').checked,
                eggs:document.getElementById('filter-eggs').checked,
                peanuts:document.getElementById('filter-peanuts').checked,
                soy:document.getElementById('filter-soy').checked
            };
        }

        function checkIng(ing,f) {
            const l = ing.toLowerCase();
            const v = [];
            if(f.pork) biblical.pork.forEach(i=>{if(l.includes(i))v.push({cat:'Pork/Swine',ing})});
            if(f.shellfish) biblical.shellfish.forEach(i=>{if(l.includes(i))v.push({cat:'Shellfish',ing})});
            if(f.unclean) biblical.unclean.forEach(i=>{if(l.includes(i))v.push({cat:'Unclean Animals',ing})});
            if(f.unclean) biblical.insects.forEach(i=>{if(l.includes(i))v.push({cat:'Insects',ing})});
            if(f.blood) biblical.blood.forEach(i=>{if(l.includes(i))v.push({cat:'Blood',ing})});
            Object.keys(hidden).forEach(h=>{if(l.includes(h))v.push({cat:'Hidden',ing,note:hidden[h]})});
            if(f.dairy) allergens.dairy.forEach(i=>{if(l.includes(i))v.push({cat:'Dairy',ing})});
            if(f.eggs) allergens.eggs.forEach(i=>{if(l.includes(i))v.push({cat:'Eggs',ing})});
            if(f.peanuts) allergens.peanuts.forEach(i=>{if(l.includes(i))v.push({cat:'Peanuts',ing})});
            if(f.soy) allergens.soy.forEach(i=>{if(l.includes(i))v.push({cat:'Soy',ing})});
            return v;
        }

        function analyze(p,f) {
            if(!p.ing && !p.ingredients_text) return {ok:null,v:[]};
            const ings = (p.ing||p.ingredients_text).split(',').map(i=>i.trim());
            const all = [];
            ings.forEach(i=>{all.push(...checkIng(i,f))});
            return {ok:all.length===0,v:all};
        }

        function addRecent(p) {
            recent = recent.filter(r=>r.code!==p.code);
            recent.unshift({code:p.code,name:p.name||p.product_name,brand:p.brand||p.brands});
            recent = recent.slice(0,10);
            localStorage.setItem('recent',JSON.stringify(recent));
            renderRecent();
        }

        function renderRecent() {
            const el = document.getElementById('recentlyViewed');
            const grid = document.getElementById('recentGrid');
            if(recent.length===0) {el.style.display='none'; return;}
            el.style.display='block';
            grid.innerHTML = recent.map(r=>`
                <div class="recent-card" onclick="searchSpecific('${r.name}')">
                    <div style="font-weight:600;font-size:0.875rem;">${r.name}</div>
                    <div style="font-size:0.75rem;color:#6b7280;">${r.brand}</div>
                </div>
            `).join('');
        }

        function render() {
            const res = document.getElementById('results');
            const f = getFilters();
            if(currProds.length===0){res.innerHTML='<div style="text-align:center;padding:3rem;color:#6b7280;">Search to see results</div>';return;}
            const analyzed = currProds.map(p=>({...p,a:analyze(p,f)}));
            res.innerHTML = analyzed.map(p=>{
                const open = openProds.has(p.code);
                const badge = p.a.ok===null?'no-data':p.a.ok?'compliant':'not-compliant';
                const text = p.a.ok===null?'No Data':p.a.ok?'‚úì Compliant':'‚úó Not Compliant';
                return `
                    <div class="product-card">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem;">
                            <div>
                                <div class="product-name">${p.name||p.product_name||'Unknown'}</div>
                                <div class="product-brand">${p.brand||p.brands||'Unknown'}</div>
                                ${p.src?`<div class="product-source">‚ö° ${p.src}</div>`:''}
                            </div>
                            <span class="status-badge ${badge}">${text}</span>
                        </div>
                        ${p.a.v.length>0?`
                            <div class="violations">
                                <div style="font-weight:700;color:#991b1b;margin-bottom:0.75rem;">‚ö† Issues:</div>
                                ${p.a.v.map(v=>`
                                    <div class="violation-item">
                                        <strong>${v.cat}:</strong> ${v.ing}
                                        ${v.note?`<span class="violation-note">(${v.note})</span>`:''}
                                    </div>
                                `).join('')}
                            </div>
                        `:''}
                        ${p.ing||p.ingredients_text?`
                            <button class="toggle-btn" onclick="toggle('${p.code}')">
                                ${open?'Hide':'View'} Ingredients
                            </button>
                            ${open?`<div class="ingredients-box"><div style="font-weight:700;margin-bottom:0.5rem;font-size:0.875rem;">Ingredients:</div><div style="color:#4b5563;font-size:0.875rem;">${p.ing||p.ingredients_text}</div></div>`:''}
                        `:''}
                    </div>
                `;
            }).join('');
        }

        function toggle(code) {
            openProds.has(code)?openProds.delete(code):openProds.add(code);
            render();
        }

        async function search() {
            const term = document.getElementById('searchInput').value.trim().toLowerCase();
            if(!term)return;
            const btn = document.getElementById('searchBtn');
            btn.disabled=true;
            btn.textContent='Searching...';

            const offline = offlineDB.filter(p=>
                p.name.toLowerCase().includes(term)||
                p.brand.toLowerCase().includes(term)
            );

            if(offline.length>0) {
                currProds=offline;
                offline.forEach(p=>addRecent(p));
                render();
                btn.disabled=false;
                btn.textContent='Search';
                return;
            }

            try {
                const r = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(term)}&search_simple=1&action=process&json=1&page_size=20`);
                const d = await r.json();
                if(d.products&&d.products.length>0) {
                    currProds=d.products.map(p=>({...p,src:'api'}));
                    d.products.forEach(p=>addRecent(p));
                    render();
                } else {
                    document.getElementById('results').innerHTML='<div style="text-align:center;padding:3rem;color:#6b7280;">No products found</div>';
                }
            } catch(e) {
                document.getElementById('results').innerHTML='<div style="text-align:center;padding:3rem;color:#6b7280;">Search failed. Try again.</div>';
            }
            btn.disabled=false;
            btn.textContent='Search';
        }

        function searchSpecific(name) {
            document.getElementById('searchInput').value=name;
            switchTab('search');
            search();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        function searchIng() {
            const term = document.getElementById('ingredientInput').value.trim().toLowerCase();
            const res = document.getElementById('ingredientResult');
            if(!term){res.innerHTML='';return;}
            const match = ingDB[term];
            if(match) {
                res.innerHTML=`
                    <div class="ingredient-result">
                        <div class="ingredient-name">${match.name}</div>
                        <span class="ingredient-category">${match.cat}</span>
                        <div class="ingredient-description">${match.desc}</div>
                        <div style="color:#dc2626;font-weight:600;margin-top:0.5rem;">‚ö† ${match.concern}</div>
                    </div>
                `;
            } else {
                res.innerHTML='<div style="padding:1rem;color:#6b7280;">Ingredient not in database. Try: gelatin, carmine, shellac</div>';
            }
        }

        function renderCommonIngs() {
            document.getElementById('commonIngredients').innerHTML = Object.keys(ingDB).map(k=>`
                <div class="ingredient-card" onclick="document.getElementById('ingredientInput').value='${k}';searchIng();">
                    <div style="font-weight:700;">${ingDB[k].name}</div>
                    <div style="font-size:0.75rem;color:#6b7280;">${ingDB[k].cat}</div>
                </div>
            `).join('');
        }

        document.getElementById('searchBtn').addEventListener('click',search);
        document.getElementById('searchInput').addEventListener('keypress',e=>{if(e.key==='Enter')search()});
        document.getElementById('ingredientInput').addEventListener('input',searchIng);
        document.querySelectorAll('.filter-item input').forEach(i=>i.addEventListener('change',()=>{
            const id = i.id.replace('filter-','');
            localStorage.setItem(id,i.checked);
            render();
        }));

        Object.keys(biblical).concat(Object.keys(allergens)).forEach(k=>{
            const el = document.getElementById(`filter-${k}`);
            if(el) {
                const saved = localStorage.getItem(k);
                if(saved!==null) el.checked = saved==='true';
            }
        });

        renderRecent();
        renderCommonIngs();
    </script>
</body>
</html>